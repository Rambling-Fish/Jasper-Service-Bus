<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:json="http://www.mulesoft.org/schema/mule/json" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns:file="http://www.mulesoft.org/schema/mule/file" xmlns:jms="http://www.mulesoft.org/schema/mule/jms" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:spring="http://www.springframework.org/schema/beans" xmlns:core="http://www.mulesoft.org/schema/mule/core" xmlns:email="http://www.mulesoft.org/schema/mule/email" xmlns:ajax="http://www.mulesoft.org/schema/mule/ajax" xmlns:tcp="http://www.mulesoft.org/schema/mule/tcp" xmlns:ftp="http://www.mulesoft.org/schema/mule/ftp" xmlns:mulexml="http://www.mulesoft.org/schema/mule/xml" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:jasperengine="http://www.mulesoft.org/schema/mule/jasperengine" version="CE-3.3.0" xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd 
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
http://www.mulesoft.org/schema/mule/file http://www.mulesoft.org/schema/mule/file/current/mule-file.xsd 
http://www.mulesoft.org/schema/mule/jms http://www.mulesoft.org/schema/mule/jms/current/mule-jms.xsd 
http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd 
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd 
http://www.mulesoft.org/schema/mule/email http://www.mulesoft.org/schema/mule/email/current/mule-email.xsd 
http://www.mulesoft.org/schema/mule/ajax http://www.mulesoft.org/schema/mule/ajax/current/mule-ajax.xsd 
http://www.mulesoft.org/schema/mule/tcp http://www.mulesoft.org/schema/mule/tcp/current/mule-tcp.xsd 
http://www.mulesoft.org/schema/mule/ftp http://www.mulesoft.org/schema/mule/ftp/current/mule-ftp.xsd 
http://www.mulesoft.org/schema/mule/xml http://www.mulesoft.org/schema/mule/xml/current/mule-xml.xsd 
http://www.mulesoft.org/schema/mule/jasperengine http://www.mulesoft.org/schema/mule/jasperengine/current/mule-jasperengine.xsd ">
    <jasperengine:connector name="JEC" vendor="jasper" appName="jta-interface-idarvideo-rest" version="1.1" deploymentId="jasperLab" jasperEngineURL="${jasperEngineURL}" doc:name="JasperEngineConnector"/>
    <http:endpoint host="${rest.http.endpoint.host}" port="${rest.http.endpoint.port}" path="${rest.http.endpoint.path}" name="globalHttpEndpoint" doc:name="HTTP"/>
    <flow name="jta-interface-idarvideo-rest-cache-write-flow" doc:name="jta-interface-idarvideo-rest-cache-write-flow">
        <jasperengine:inbound-endpoint topic="jms.jasper.1.0.idarvideo.topic" connector-ref="JEC" doc:name="JECEndpoint"></jasperengine:inbound-endpoint>
        <jms:jmsmessage-to-object-transformer returnClass="org.jasper.jLib.idar.video.codec.IDARVideoMessage" doc:name="JEC msg to IDARVideoMessage"/>
        <component class="org.jasper.engine.idarvideo.cache.JasperIdarVideoSimpleCache" doc:name="JasperIdarVideo SimpleCache"/>
    </flow>
    <flow name="jta-interface-idarvideo-rest-cache-read-flow" doc:name="jta-interface-idarvideo-rest-cache-read-flow">
        <http:inbound-endpoint exchange-pattern="request-response" ref="globalHttpEndpoint" doc:name="bulletinList"/>
        <component class="org.jasper.engine.idarvideo.cache.JasperIdarVideoSimpleCache" doc:name="JasperIdarVideo SimpleCache"/>
        <choice doc:name="Choice">
            <when expression="message.payload is org.jasper.jLib.idar.video.codec.IDARVideoMessage">
                <processor-chain>
                    <custom-transformer class="org.jasper.jLib.idar.video.transformer.IDARtoJPEG" doc:name="JPEGfromObject"/>
                    <file:outbound-endpoint path="${app.home}/docroot" outputPattern="intelliDAR.jpg" responseTimeout="10000" mimeType="image/jpeg" doc:name="File"/>
                </processor-chain>
            </when>
            <otherwise>
                <processor-chain>
                    <choice doc:name="Choice">
                        <when expression="message.payload != 'JASPER ASB --- Resource Not Found.'">
                            <processor-chain>
                                <custom-transformer class="org.jasper.jLib.idar.video.transformer.IDARtoXML" doc:name="XMLfromObject"/>
                                <custom-transformer class="org.mule.module.json.transformers.XmlToJson" doc:name="XMLtoJson"/>
                            </processor-chain>
                        </when>
                        <otherwise>
                            <processor-chain>
                                <json:object-to-json-transformer doc:name="Object to JSON"/>
                            </processor-chain>
                        </otherwise>
                    </choice>
                </processor-chain>
            </otherwise>
        </choice>
    </flow>
</mule>
